---
import "../styles/global.css";
import "../styles/Player.css";

import { getSetting } from "../lib/db";
import { APP_VERSION, APP_STATUS } from "../config/version";

/* ===================== USER COOKIE ===================== */

const cookies = Astro.request.headers.get("cookie");
let user = null;

try {
  const match = cookies?.match(/bungie=([^;]+)/);
  if (match) {
    user = JSON.parse(decodeURIComponent(match[1]));
  }
} catch {}

/* ===================== SITE SETTINGS ===================== */

const appVersion =
  (await getSetting("app_version")) ?? APP_VERSION;

const appStatus =
  (await getSetting("app_status")) ?? APP_STATUS;

const discordInvite =
  (await getSetting("discord_invite")) ??
  "https://discord.gg/yourlink";

const { title = "CruciCore — Destiny 2 PvP & Trials Tracker" } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <title>{title}</title>
  </head>

  <body class="site-root">
    <!-- ===================== HEADER ===================== -->
    <nav class="header">
      <div class="header-left">
        <a href="/" class="brand-link">
          <div class="brand-solid">
            Cruci<span>Core</span>
          </div>
        </a>
      </div>

      <div class="header-right">
        <a class="nav-link" href="/help">Help</a>

        <div class="user-menu">
          {
            user ? (
              <button class="user-icon" aria-label="User menu">
                <span class="user-initial">
                  {user.displayName?.[0] ?? "U"}
                </span>
              </button>
            ) : (
              <a
                href="/api/auth?action=login"
                class="user-icon"
                aria-label="Sign in"
                title="Sign in with Bungie"
              >
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M10 17l5-5-5-5v10zM20 3H4a1 1 0 00-1 1v4h2V5h14v14H5v-3H3v4a1 1 0 001 1h16a1 1 0 001-1V4a1 1 0 00-1-1z" />
                </svg>
              </a>
            )
          }

          {
            user && (
              <div class="user-dropdown">
                <div class="user-meta">
                  <strong>{user.displayName}</strong>
                  <span class="muted">Bungie Account</span>
                </div>

                <a href={`/profile/${user.membershipType}/${user.membershipId}`}>
                  Profile
                </a>
                <a href="/profile/settings">Settings</a>

                <div class="divider" />

                <a href="/api/auth?action=logout" class="danger">
                  Logout
                </a>
              </div>
            )
          }
        </div>
      </div>
    </nav>

    <!-- ===================== CONTENT ===================== -->
    <main class="site-main">
      <slot />
    </main>

    <!-- ===================== FOOTER ===================== -->
    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-left">
          <span>
            CruciCore · v{appVersion}
            <span class="status-badge">{appStatus}</span>
          </span>
        </div>

        <div class="footer-right">
          <div class="footer-links">
            <a href="/help">Help</a>
            <a href={discordInvite} target="_blank" rel="noopener">
              Discord
            </a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>