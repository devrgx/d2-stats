---
/* @ts-nocheck */
import "../styles/CompRankBars.css";

type DivisionName =
  | "Copper"
  | "Bronze"
  | "Silver"
  | "Gold"
  | "Platinum"
  | "Adept"
  | "Ascendant"
  | "Ascendant Zero";

const { points = 0 } = Astro.props;

const isUntested = points === 0;

const divisions: {
  name: DivisionName;
  tiers: number[];
}[] = [
  { name: "Copper", tiers: [250, 500, 500] },
  { name: "Bronze", tiers: [500, 500, 500] },
  { name: "Silver", tiers: [500, 500, 500] },
  { name: "Gold", tiers: [500, 500, 500] },
  { name: "Platinum", tiers: [500, 500, 500] },
  { name: "Adept", tiers: [500, 500, 500] },
  { name: "Ascendant", tiers: [500, 500, 250] },
  { name: "Ascendant Zero", tiers: [5000] },
];

const colors: Record<DivisionName, string> = {
  Copper: "#b87333",
  Bronze: "#cd7f32",
  Silver: "#c0c0c0",
  Gold: "#ffd700",
  Platinum: "#4fd1c5",
  Adept: "#8a2be2",
  Ascendant: "#00d1ff",
  "Ascendant Zero": "#ff0077",
};

// ----- Division ranges -----
let cursor = 0;
const divs = divisions.map((d) => {
  const span = d.tiers.reduce((a, b) => a + b, 0);
  const min = cursor;
  const max = cursor + span - 1;
  cursor = max + 1;
  return { ...d, min, max, span };
});

const current =
  divs.find((d) => points >= d.min && points <= d.max) ?? divs[divs.length - 1];

const localPoints = Math.max(0, points - current.min);

// ----- Text logic -----
let infoText: string | null = null;
let nextRankText: string | null = null;
let ascendantText: string | null = null;

if (points === 0) {
  infoText = "Complete your 7 placement matches to be placed in a division.";
}

if (points > 0 && points < 10000) {
  const idx = divs.findIndex((d) => d.name === current.name);
  const next = divs[idx + 1];
  if (next) {
    const diff = next.min - points;
    nextRankText = `+${diff.toLocaleString("de-DE")} points to reach ${next.name}`;
  }
}

if (points > 0 && points < 8750) {
  const diffAsc = 8750 - points;
  ascendantText = `+${diffAsc.toLocaleString("de-DE")} points to reach Ascendant`;
}

if (points >= 10000) {
  infoText =
    "You are in Ascendant Zero. Win matches for a chance to earn this emblem.";
}

const showAscendantEmblem = points < 8750;
const showAscendantZeroEmblem = points >= 10000;
---

<div class="comp-rank-box">
  <div class="comp-rank-header">
    <h3>Competitive Division â€” {isUntested ? "Untested" : current.name}</h3>
  </div>

  <div class="rank-points">
    <span>{points.toLocaleString("de-DE")} / 15000</span>

    {
      !isUntested && points < 10000 && (
        <span class="rank-points-division">
          {points.toLocaleString("de-DE")} /{" "}
          {current.max.toLocaleString("de-DE")}
        </span>
      )
    }
  </div>

  {
    !isUntested && (
      <div class="division-bar">
        {current.tiers.map((tier, idx) => {
          const segStart = current.tiers
            .slice(0, idx)
            .reduce((a, b) => a + b, 0);

          let fill = 0;
          if (localPoints > segStart) {
            fill = Math.min(100, ((localPoints - segStart) / tier) * 100);
          }

          return (
            <div class="segment">
              <div
                class="segment-fill"
                style={`--fill:${fill}%;--color:${colors[current.name]}`}
              />
            </div>
          );
        })}
      </div>
    )
  }

  {
    !isUntested && current.name !== "Ascendant Zero" && (
      <div class="division-tiers">
        <span>III</span>
        <span>II</span>
        <span>I</span>
      </div>
    )
  }

  {nextRankText && <div class="rank-next">{nextRankText}</div>}
  {ascendantText && <div class="rank-ascendant">{ascendantText}</div>}
  {infoText && <div class="rank-info">{infoText}</div>}

  {
    (showAscendantEmblem || showAscendantZeroEmblem) && (
      <div class="rank-emblem">
        <div class="rank-emblem-text">
          {showAscendantZeroEmblem
            ? "Ascendant Zero Emblem"
            : "Reach Ascendant this season to earn this emblem."}
        </div>

        <img
          src={
            showAscendantZeroEmblem
              ? "https://www.bungie.net/common/destiny2_content/icons/131a311fef76952e5929233a33a7155a.jpg"
              : "https://www.bungie.net/common/destiny2_content/icons/49f1dffd918e5c772b83be9432d47f38.jpg"
          }
          alt="Competitive Emblem"
        />
      </div>
    )
  }
</div>
