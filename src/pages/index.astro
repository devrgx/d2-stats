---
import Layout from "../layouts/Layout.astro";
export const prerender = false;
---

<Layout title="CruciCore — Destiny 2 PvP & Trials Tracker">
  <!-- ===================== HERO ===================== -->
  <section class="hero hero-fill">
    <div class="hero-inner">
      <h1 class="hero-title">
        Destiny 2 PvP<br />
        <span>Performance & Trials Tracker</span>
      </h1>

      <p class="hero-sub">
        Track competitive PvP stats, Trials of Osiris rotations and player
        performance using live Bungie API data.
      </p>

      <div class="hero-actions">
        <div class="search-wrapper">
          <input
            class="hero-input"
            type="text"
            placeholder="Enter Bungie Name (e.g. name#1234)"
            autocomplete="off"
          />
          <ul class="search-suggestions" hidden></ul>
        </div>
      </div>

      <div class="hero-meta">
        <span
          class="status-badge"
          data-tooltip="CruciCore is currently in early development. Features may change or break."
          >Early Preview</span
        >
      </div>
    </div>
  </section>

  <!-- ===================== NOW IN ROTATION ===================== -->
  <section class="container">
    <h2>Now in Rotation</h2>

    <div class="grid">
      <div class="card col-4">
        <strong>Trials Map</strong>
        <p class="muted">Current weekend</p>
        <span>—</span>
      </div>

      <div class="card col-4">
        <strong>Trials Loot</strong>
        <p class="muted">Adept (if Flawless)</p>
        <span>—</span>
      </div>

      <div class="card col-4">
        <strong>Crucible Rotator</strong>
        <p class="muted">Weekly playlist</p>
        <span>—</span>
      </div>
    </div>
  </section>

  <!-- ===================== FEATURE PREVIEW ===================== -->
  <section class="container">
    <h2>What you can track</h2>

    <div class="grid">
      <div class="card col-4">
        <strong>PvP Performance</strong>
        <p class="muted">
          K/D, win rate and recent activity across PvP playlists.
        </p>
      </div>

      <div class="card col-4">
        <strong>Trials of Osiris</strong>
        <p class="muted">
          Weekly map rotations, flawless loot and performance insights.
        </p>
      </div>

      <div class="card col-4">
        <strong>Competitive Rank</strong>
        <p class="muted">
          Division progress, rank changes and seasonal overview.
        </p>
      </div>
    </div>
  </section>

  <!-- ===================== COMING SOON ===================== -->
  <section class="container">
    <h2>Coming soon</h2>
    <p class="muted">
      Challenges, curated milestones, Discord bot integration and more.
    </p>
  </section>
</Layout>

<script>
  const input = document.querySelector(".hero-input") as HTMLInputElement;
  const list = document.querySelector(".search-suggestions") as HTMLElement;

  let abortCtrl: AbortController;

  function dedupeByName(results: any) {
    const map = new Map();
    for (const r of results) {
      if (!map.has(r.displayName)) {
        map.set(r.displayName, r);
      }
    }
    return Array.from(map.values());
  }

  input.addEventListener("input", async () => {
    const q = input.value.trim();

    if (q.length < 2) {
      list.hidden = true;
      list.innerHTML = "";
      return;
    }

    if (abortCtrl) abortCtrl.abort();
    abortCtrl = new AbortController();

    try {
      const res = await fetch("/api/search", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ query: q }),
        signal: abortCtrl.signal,
      });

      const data = await res.json();
      const results = dedupeByName(data);

      if (!results.length) {
        list.hidden = true;
        list.innerHTML = "";
        return;
      }

      list.innerHTML = results
        .map(
          (r) => `
    <li data-type="${r.membershipType}" data-id="${r.membershipId}">
      <div class="suggestion">
        <div class="suggestion-emblem"></div>
        <div class="suggestion-text">
          <strong>${r.displayName}</strong>
          <span class="sub">Open profile</span>
        </div>
      </div>
    </li>
  `,
        )
        .join("");

      if (list) list.hidden = false;
    } catch (e) {
      if ((e as Error).name !== "AbortError") {
        console.error("search failed", e);
      }
    }
  });

  list?.addEventListener("click", (e) => {
    const li = (e.target as HTMLElement)?.closest("li");
    if (!li) return;

    const type = li.dataset.type;
    const id = li.dataset.id;

    window.location.href = `/profile/${type}/${id}`;
  });
</script>
