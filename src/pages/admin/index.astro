---
import Layout from "../../layouts/Layout.astro";
import { getSetting } from "../../lib/db";

/* ===================== ADMIN AUTH ===================== */

const isAdmin = Astro.cookies.get("cc_admin");
if (!isAdmin) {
  return Astro.redirect("/admin/login");
}

/* ===================== SETTINGS ===================== */

const appVersion = (await getSetting("app_version")) ?? "0.1.0";
const appStatus = (await getSetting("app_status")) ?? "Early Preview";
const discordInvite =
  (await getSetting("discord_invite")) ?? "https://discord.gg/yourlink";
---

<Layout title="Admin Panel · CruciCore">
  <section class="container">
    <h1>Admin Panel</h1>

    <!-- ================= SETTINGS ================= -->
    <h2>Site Settings</h2>

    <form method="POST" action="/api/admin?action=settings">
      <label>
        App Version
        <input type="text" name="app_version" value={appVersion} />
      </label>

      <label>
        App Status
        <input type="text" name="app_status" value={appStatus} />
      </label>

      <label>
        Discord Invite
        <input type="text" name="discord_invite" value={discordInvite} />
      </label>

      <button type="submit" class="btn primary">
        Save Settings
      </button>
    </form>

    <hr />

    <!-- ================= TRIALS ================= -->
    <h2>Trials Rotation</h2>

    <form method="POST" action="/api/trials">
      <label>
        Active
        <input type="checkbox" name="active" />
      </label>

      <label>
        Map
        <input
          type="text"
          name="map_name"
          id="map-input"
          placeholder="Start typing a PvP map…"
          autocomplete="off"
          required
        />
      </label>

      <ul id="map-suggestions" class="map-suggestions"></ul>

      <button type="submit" class="btn primary">
        Update Trials
      </button>
    </form>

    <hr />

    <!-- ================= LOGOUT ================= -->
    <form method="POST" action="/api/admin?action=logout">
      <button type="submit" class="btn">
        Logout
      </button>
    </form>
  </section>

  <a href="/admin/badges">Manage Badges</a>

  <!-- ================= MAP AUTOCOMPLETE ================= -->
  <script>
    const input = document.getElementById("map-input");
    const list = document.getElementById("map-suggestions");

    if (input instanceof HTMLInputElement && list) {
      let controller: AbortController;

      input.addEventListener("input", async () => {
        const q = input.value.trim();
        list.innerHTML = "";
        if (!q) return;

        if (controller) controller.abort();
        controller = new AbortController();

        const res = await fetch(`/api/maps?q=${encodeURIComponent(q)}`, {
          signal: controller.signal,
        });

        const maps = await res.json();

        for (const m of maps) {
          const li = document.createElement("li");
          li.textContent = m.name;
          li.addEventListener("click", () => {
            input.value = m.name;
            list.innerHTML = "";
          });
          list.appendChild(li);
        }
      });
    }
  </script>

  <style>
    .map-suggestions {
      list-style: none;
      margin: 6px 0 0;
      padding: 0;
      background: rgba(20, 24, 32, 0.95);
      border: 1px solid rgba(120, 190, 255, 0.18);
      border-radius: 10px;
      max-height: 220px;
      overflow-y: auto;
    }

    .map-suggestions li {
      padding: 8px 12px;
      cursor: pointer;
    }

    .map-suggestions li:hover {
      background: rgba(0, 209, 255, 0.12);
    }

    form {
      margin-bottom: 32px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 420px;
    }

    hr {
      margin: 40px 0;
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
  </style>
</Layout>