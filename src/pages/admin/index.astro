---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { getSetting } from "../../lib/db";

/* ===================== ADMIN AUTH ===================== */

const isAdmin = Astro.cookies.get("cc_admin");
if (!isAdmin) {
  return Astro.redirect("/admin/login");
}

/* ===================== SETTINGS ===================== */

const appVersion = (await getSetting("app_version")) ?? "0.1.0";
const appStatus = (await getSetting("app_status")) ?? "Early Preview";
const discordInvite =
  (await getSetting("discord_invite")) ?? "https://discord.gg/yourlink";
---

<AdminLayout title="Admin Panel · CruciCore">
  <section class="container">
    <h1>Admin Panel</h1>

    <h2>Site Settings</h2>

    <form method="POST" action="/api/admin?action=settings">
      <label>
        App Version
        <input type="text" name="app_version" value={appVersion} />
      </label>

      <label>
        App Status
        <input type="text" name="app_status" value={appStatus} />
      </label>

      <label>
        Discord Invite
        <input type="text" name="discord_invite" value={discordInvite} />
      </label>

      <button type="submit" class="btn primary">
        Save Settings
      </button>
    </form>

    <hr />

    <h2>Trials Rotation</h2>

    <form method="POST" action="/api/trials">
      <label>
        Active
        <input type="checkbox" name="active" />
      </label>

      <label>
        Map
        <input
          type="text"
          name="map_name"
          id="map-input"
          placeholder="Start typing a PvP map…"
          autocomplete="off"
          required
        />
      </label>

      <ul id="map-suggestions" class="map-suggestions"></ul>

      <button type="submit" class="btn primary">
        Update Trials
      </button>
    </form>
  </section>

  <!-- ================= MAP AUTOCOMPLETE ================= -->
  <script>
    const input = document.getElementById("map-input");
    const list = document.getElementById("map-suggestions");

    if (input instanceof HTMLInputElement && list) {
      let controller: AbortController;

      input.addEventListener("input", async () => {
        const q = input.value.trim();
        list.innerHTML = "";
        if (!q) return;

        if (controller) controller.abort();
        controller = new AbortController();

        const res = await fetch(`/api/maps?q=${encodeURIComponent(q)}`, {
          signal: controller.signal,
        });

        const maps = await res.json();

        for (const m of maps) {
          const li = document.createElement("li");
          li.textContent = m.name;
          li.addEventListener("click", () => {
            input.value = m.name;
            list.innerHTML = "";
          });
          list.appendChild(li);
        }
      });
    }
  </script>
</AdminLayout>