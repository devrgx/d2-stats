---
import AdminLayout from "../../layouts/AdminLayout.astro";
import BadgePill from "../../components/BadgePill.astro";
import { BADGES, ALL_BADGE_KEYS } from "../../constants/badges";

const isAdmin = !!Astro.cookies.get("cc_admin");
---

<AdminLayout title="Admin · Badges">
  {!isAdmin ? (
    <section class="admin-wrap">
      <div class="admin-card">
        <h1>Unauthorized</h1>
        <p>You must be logged in as admin.</p>
        <a href="/admin/login">Go to login</a>
      </div>
    </section>
  ) : (
    <section class="admin-wrap">
      <h1>Badge Administration</h1>
      <p class="muted">
        Assign one or multiple badges to a user by Bungie membershipId.
      </p>

      <div class="admin-grid">
        <!-- USER -->
        <div class="admin-card">
          <h2>User</h2>

          <label>Membership ID</label>
          <div class="row">
            <input
              id="membershipId"
              class="input mono"
              placeholder="4611686018..."
            />
            <button id="loadBtn" class="btn">Load</button>
          </div>

          <p class="hint">
            Paste the Bungie membershipId directly.
          </p>

          <div id="status" class="status muted">
            No user loaded.
          </div>
        </div>

        <!-- BADGES -->
        <div class="admin-card">
          <h2>Badges</h2>

          <div class="badge-grid" id="badgeGrid">
            {ALL_BADGE_KEYS
              .slice()
              .sort((a, b) => BADGES[a].priority - BADGES[b].priority)
              .map((key) => (
                <label class="badge-item">
                  <input type="checkbox" value={key} />
                  <div class="badge-info">
                    <BadgePill badge={key} />
                    <div class="badge-desc">
                      {BADGES[key].description}
                    </div>
                  </div>
                </label>
              ))}
          </div>

          <div class="actions">
            <button id="clearBtn" class="btn ghost">Clear</button>
            <div class="spacer"></div>
            <button id="saveBtn" class="btn primary">Save</button>
          </div>

          <h3>Preview</h3>
          <div id="preview" class="preview muted">
            No badges selected.
          </div>
        </div>
      </div>
    </section>
  )}

  <script is:inline>
    // @ts-nocheck
    const $ = (id) => document.getElementById(id);

    const membershipIdInput = $("membershipId");
    const loadBtn = $("loadBtn");
    const saveBtn = $("saveBtn");
    const clearBtn = $("clearBtn");
    const status = $("status");
    const preview = $("preview");
    const checkboxes = Array.from(
      document.querySelectorAll('.badge-item input[type="checkbox"]')
    );

    let currentMembershipId = "";

    function setStatus(text, type = "muted") {
      status.className = "status " + type;
      status.textContent = text;
    }

    function selectedBadges() {
      return checkboxes.filter(c => c.checked).map(c => c.value);
    }

    function updatePreview() {
      const selected = selectedBadges();
      if (!selected.length) {
        preview.textContent = "No badges selected.";
        preview.className = "preview muted";
        return;
      }

      preview.className = "preview";
      preview.innerHTML = selected.map(b => {
        const pill = document.querySelector(
          `.badge-item input[value="${b}"]`
        ).closest(".badge-item").querySelector(".badge-pill");
        return pill.outerHTML;
      }).join(" ");
    }

    async function loadBadges() {
      const id = membershipIdInput.value.trim();
      if (!id) return setStatus("membershipId required", "error");

      setStatus("Loading…");
      currentMembershipId = id;

      const res = await fetch(
        `/api/admin/badges?membershipId=${encodeURIComponent(id)}`
      );
      const data = await res.json();

      if (!res.ok) {
        setStatus(data.error || "Failed", "error");
        return;
      }

      for (const c of checkboxes) {
        c.checked = data.badges.includes(c.value);
      }

      updatePreview();
      setStatus("Loaded", "ok");
    }

    async function saveBadges() {
      if (!currentMembershipId) {
        setStatus("Load a user first", "error");
        return;
      }

      setStatus("Saving…");

      const res = await fetch("/api/admin/badges", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          membershipId: currentMembershipId,
          badges: selectedBadges(),
        }),
      });

      const data = await res.json();
      if (!res.ok) {
        setStatus(data.error || "Failed", "error");
        return;
      }

      setStatus("Saved", "ok");
    }

    loadBtn.onclick = loadBadges;
    saveBtn.onclick = saveBadges;
    clearBtn.onclick = () => {
      checkboxes.forEach(c => (c.checked = false));
      updatePreview();
    };

    checkboxes.forEach(c => c.onchange = updatePreview);
  </script>

  <style>
    .admin-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1.4fr;
      gap: 16px;
    }

    .admin-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 16px;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .input {
      flex: 1;
      padding: 8px 10px;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .badge-item {
      display: flex;
      gap: 10px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      cursor: pointer;
    }

    .badge-desc {
      font-size: 12px;
      opacity: 0.75;
    }

    .actions {
      display: flex;
      margin-top: 12px;
      gap: 8px;
    }

    .preview {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      min-height: 36px;
    }
  </style>
</AdminLayout>