---
import Layout from "../../../layouts/Layout.astro";
import StatBlock from "../../../components/StatBlock.astro";
import CompRankBars from "../../../components/CompRankBars.astro";

import { listBadgesByPlayer } from "../../../lib/db";

let badges: {
  badge_text: string;
  tooltip?: string;
  badge_class?: string;
}[] = [];

export const prerender = false;

const { type, id } = Astro.params;

const membershipType = Number(type);
const membershipId = id;
const apiKey = import.meta.env.BUNGIE_API_KEY;

// ===== Standardwerte =====
let playerName = "Unknown Guardian";
let bungieTag = "";
let clanName = "[C] Crucis";
let emblemBackground = "/missing_emblem_special.jpg";
let emblemIcon = "/missing_emblem_icon.png";
let compPoints = 0;
let compProgressToNext = 0;
let compNextLevelAt = 0;

// ===== Socials (Platzhalter) =====
const socials = {
  twitch: "test",
  youtube: "test",
  reddit: "test",
  website: "https://beta.notrgx.com/",
};

try {
  // 1️⃣ Profil abrufen
  const res = await fetch(
    `https://www.bungie.net/Platform/Destiny2/${membershipType}/Profile/${membershipId}/?components=100,200,202,900`,
    { headers: { "X-API-Key": apiKey } },
  );
  const data = await res.json();
  if (!data?.Response) throw new Error("Invalid Bungie API response");

  // 2️⃣ Name + Clan
  const user = data.Response.profile?.data?.userInfo;
  if (user) {
    playerName =
      user.bungieGlobalDisplayName ?? user.displayName ?? "Unknown Guardian";
    bungieTag = user.bungieGlobalDisplayNameCode
      ? `#${user.bungieGlobalDisplayNameCode}`
      : "";
  }
  clanName = data.Response?.profile?.data?.clanName ?? "[C] Crucis";

  // 3️⃣ Charakterdaten
  const characters = data.Response.characters?.data ?? {};
  const firstChar = Object.values(characters)[0] as
    | {
        emblemPath?: string;
        emblemBackgroundPath?: string;
        emblemHash?: number;
      }
    | undefined;

  if (firstChar) {
    if (firstChar.emblemPath)
      emblemIcon = `https://www.bungie.net${firstChar.emblemPath}`;
    if (firstChar.emblemBackgroundPath)
      emblemBackground = `https://www.bungie.net${firstChar.emblemBackgroundPath}`;

    // 4️⃣ Manifest-Call → Secondary Special
    if (firstChar.emblemHash) {
      const manRes = await fetch(
        `https://www.bungie.net/Platform/Destiny2/Manifest/DestinyInventoryItemDefinition/${firstChar.emblemHash}/`,
        { headers: { "X-API-Key": apiKey } },
      );
      const man = await manRes.json();
      const def = man?.Response ?? {};
      const special =
        def.secondarySpecial ??
        def.secondaryOverlay ??
        def.secondaryIcon ??
        null;
      if (special) emblemBackground = `https://www.bungie.net${special}`;
    }
  }

  // 5️⃣ COMP Punkte (Progression 3696598664)
  const progressions = (data.Response.characterProgressions?.data ??
    {}) as Record<string, { progressions?: Record<string, any> }>;
  const firstProg = Object.values(progressions)[0]?.progressions ?? {};
  const compProg = firstProg["3696598664"];
  if (compProg) {
    compPoints = compProg.currentProgress ?? 0;
    compProgressToNext = compProg.progressToNextLevel ?? 0;
    compNextLevelAt = compProg.nextLevelAt ?? 0;
  }
} catch (err) {
  console.error("Bungie API Error:", err);
}

try {
  badges = await listBadgesByPlayer(playerName);
} catch (e) {
  console.warn("Could not load badges:", e);
}

const badgeKey = bungieTag ? `${playerName}${bungieTag}` : playerName;

badges = await listBadgesByPlayer(badgeKey);
---

<Layout title={`${playerName} — CruciCore`}>
  <!-- Emblem Header -->
  <section
    class="cc-header"
    style={`background-image:url('${emblemBackground}')`}
  >
    <div class="cc-header__scrim"></div>
    <div class="cc-header__inner">
      <img src={emblemIcon} alt="Emblem" class="cc-header__icon" />
      <div class="cc-header__info">
        <h2 class="cc-header__name">
          {playerName}
          <span class="cc-header__tag">{bungieTag}</span>

          {
            badges.length > 0 && (
              <span class="profile-badges">
                {badges.map((badge) => (
                  <span
                    class={`badge badge-${badge.badge_class ?? "default"}`}
                    data-tooltip={badge.tooltip}
                  >
                    {badge.badge_text}
                  </span>
                ))}
              </span>
            )
          }
        </h2>
        <div class="cc-header__meta">
          <span>{clanName}</span>
          <span>• Platform: Steam</span>
          <span>• Membership ID: {membershipId}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Hauptinhalt -->
  <main class="container">
    <section style="margin-top:32px;">
      <h2>Trials of Osiris</h2>
      <div class="grid">
        <div class="col-3"><StatBlock label="Weekly KD" value="—" /></div>
        <div class="col-3"><StatBlock label="Seasonal KD" value="—" /></div>
        <div class="col-3"><StatBlock label="Flawless Count" value="—" /></div>
        <div class="col-3">
          <StatBlock label="Flawless this week" value="—" />
        </div>
      </div>
    </section>

    <section style="margin-top:18px;">
      <h2>Competitive / Crucible</h2>
      <div class="grid">
        <div class="col-4"><StatBlock label="Overall KD" value="—" /></div>
        <div class="col-4"><StatBlock label="Kills" value="—" /></div>
        <div class="col-4"><StatBlock label="Deaths" value="—" /></div>
      </div>

      <div style="margin-top:20px;">
        <CompRankBars
          points={compPoints}
          nextLevelAt={compNextLevelAt}
          toNext={compProgressToNext}
        />
      </div>
    </section>
  </main>
</Layout>
