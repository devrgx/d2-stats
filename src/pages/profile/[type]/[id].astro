---
import Layout from "../../../layouts/Layout.astro";
import StatBlock from "../../../components/StatBlock.astro";
import CompRankBars from "../../../components/CompRankBars.astro";
import BadgePill from "../../../components/BadgePill.astro";

import { BADGES } from "../../../constants/badges";
import { getUserBadges } from "../../../server/badgesStore";

export const prerender = false;

const { type, id } = Astro.params;

const membershipType = Number(type);
const membershipId = id;
const apiKey = import.meta.env.BUNGIE_API_KEY;

// ===== SSR FALLBACKS =====
const playerName = "Loading Guardian";
const bungieTag = "";

const emblemBackground = "/missing_emblem_special.jpg";
const emblemIcon = "/missing_emblem_icon.png";

// ===== COMP (ALT & FUNKTIONIEREND, SSR) =====
let compPoints = 0;
let compProgressToNext = 0;
let compNextLevelAt = 0;

try {
  const res = await fetch(
    `https://www.bungie.net/Platform/Destiny2/${membershipType}/Profile/${membershipId}/?components=100,200,202,900`,
    { headers: { "X-API-Key": apiKey } }
  );

  const data = await res.json();
  const progressions = data?.Response?.characterProgressions?.data ?? {};
  const firstCharProg = Object.values(progressions)[0] as any;
  const firstProg = firstCharProg?.progressions ?? {};
  const compProg = firstProg["3696598664"];

  if (compProg) {
    compPoints = compProg.currentProgress ?? 0;
    compProgressToNext = compProg.progressToNextLevel ?? 0;
    compNextLevelAt = compProg.nextLevelAt ?? 0;
  }
} catch (e) {
  console.error("COMP SSR failed", e);
}

// ===== BADGES =====
const userBadges = membershipId
  ? getUserBadges(membershipId)
      .slice()
      .sort((a, b) => BADGES[a].priority - BADGES[b].priority)
  : [];
---

<Layout title={`${playerName} — CruciCore`}>
  <!-- ================= HEADER ================= -->
  <section
    class="cc-header"
    style={`background-image:url('${emblemBackground}')`}
    data-profile-header
    data-membership-type={membershipType}
    data-membership-id={membershipId}
  >
    <div class="cc-header__scrim"></div>

    <div class="cc-header__inner">
      <div class="cc-header__icon skeleton skeleton-avatar" data-skel-avatar></div>

      <img
        src={emblemIcon}
        alt="Emblem"
        class="cc-header__icon"
        data-profile-emblem
        style="display:none;"
      />

      <div class="cc-header__info">
        <h2 class="cc-header__name">
          <span class="skeleton skeleton-line title" data-skel-title></span>

          <span data-profile-name>{playerName}</span>
          <span class="cc-header__tag" data-profile-tag>{bungieTag}</span>

          {userBadges.length > 0 && (
            <section class="profile-badges">
              {userBadges.map((b) => (
                <BadgePill badge={b} />
              ))}
            </section>
          )}
        </h2>

        <div class="cc-header__meta">
          <span class="skeleton skeleton-line small" data-skel-meta></span>
          <span class="pill" data-meta-clan style="display:none;"></span>
          <span data-meta-sep style="display:none;">•</span>
          <span class="pill" data-meta-platform style="display:none;">
            Platform: Steam
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= CONTENT ================= -->
  <main class="container">
    <section style="margin-top:32px;">
      <h2>Trials of Osiris</h2>

      <div class="grid">
        {Array.from({ length: 4 }).map(() => (
          <div class="col-3" data-skel-trials>
            <div class="skeleton skeleton-card" />
          </div>
        ))}

        <div class="col-3" data-real-trials style="display:none;">
          <StatBlock label="Weekly KD" value="—" />
        </div>
        <div class="col-3" data-real-trials style="display:none;">
          <StatBlock label="Seasonal KD" value="—" />
        </div>
        <div class="col-3" data-real-trials style="display:none;">
          <StatBlock label="Flawless Count" value="—" />
        </div>
        <div class="col-3" data-real-trials style="display:none;">
          <StatBlock label="Flawless this week" value="—" />
        </div>
      </div>
    </section>

    <section style="margin-top:18px;">
      <h2>Competitive / Crucible</h2>

      <div class="grid">
        {Array.from({ length: 3 }).map(() => (
          <div class="col-4" data-skel-crucible>
            <div class="skeleton skeleton-card" />
          </div>
        ))}

        <div class="col-4" data-real-crucible style="display:none;">
          <StatBlock label="Overall KD" value="—" />
        </div>
        <div class="col-4" data-real-crucible style="display:none;">
          <StatBlock label="Kills" value="—" />
        </div>
        <div class="col-4" data-real-crucible style="display:none;">
          <StatBlock label="Deaths" value="—" />
        </div>
      </div>

      <div style="margin-top:20px;">
        <div class="skeleton skeleton-card" style="height:64px;" data-skel-rank></div>

        <!-- ✅ COMP WIE FRÜHER -->
        <CompRankBars
          points={compPoints}
          nextLevelAt={compNextLevelAt}
          toNext={compProgressToNext}
        />
      </div>
    </section>
  </main>

  <!-- ================= CLIENT ================= -->
  <script type="module">
    const header = document.querySelector("[data-profile-header]");
    const membershipType = header?.dataset.membershipType;
    const membershipId = header?.dataset.membershipId;

    function finish() {
      document.querySelector("[data-skel-avatar]")?.remove();
      document.querySelector("[data-skel-title]")?.remove();
      document.querySelector("[data-skel-meta]")?.remove();
      document.querySelector("[data-skel-rank]")?.remove();

      document.querySelectorAll("[data-skel-trials]").forEach(e => e.remove());
      document.querySelectorAll("[data-real-trials]").forEach(e => e.style.display = "");

      document.querySelectorAll("[data-skel-crucible]").forEach(e => e.remove());
      document.querySelectorAll("[data-real-crucible]").forEach(e => e.style.display = "");

      document.querySelector("[data-meta-platform]")?.style.setProperty("display", "");
    }

    async function run() {
      try {
        const res = await fetch(
          `/api/profile?type=${membershipType}&id=${membershipId}`
        );
        if (!res.ok) throw new Error(res.status);

        const data = await res.json();
        const profile = data.profile;
        const clan = data.clan;

        const user = profile?.profile?.data?.userInfo;
        const name = user?.bungieGlobalDisplayName ?? "Unknown Guardian";
        const code = user?.bungieGlobalDisplayNameCode;
        const tag = code ? `#${code}` : "";

        document.querySelector("[data-profile-name]").textContent = name;
        document.querySelector("[data-profile-tag]").textContent = tag;

        if (data?.emblem?.background) {
          header.style.backgroundImage = `url('${data.emblem.background}')`;
        }

        const img = document.querySelector("[data-profile-emblem]");
        if (img && data?.emblem?.icon) {
          img.src = data.emblem.icon;
          img.style.display = "";
        }

        if (clan?.name) {
          const el = document.querySelector("[data-meta-clan]");
          el.innerHTML = `${clan.tag ? `<strong>[${clan.tag}]</strong> ` : ""}${clan.name}`;
          el.style.display = "";
          document.querySelector("[data-meta-sep]").style.display = "";
        }
      } catch (e) {
        console.error("hydrate failed", e);
      } finally {
        finish();
      }
    }

    run();
  </script>
</Layout>