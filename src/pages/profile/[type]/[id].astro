---
import Layout from "../../../layouts/Layout.astro";
import StatBlock from "../../../components/StatBlock.astro";
import CompRankBars from "../../../components/CompRankBars.astro";
import BadgePill from "../../../components/BadgePill.astro";

import { BADGES } from "../../../constants/badges";
import { getUserBadges } from "../../../server/badgesStore";

let badges: {
  badge_text: string;
  tooltip?: string;
  badge_class?: string;
}[] = [];

export const prerender = false;

const { type, id } = Astro.params;

const membershipType = Number(type);
const membershipId = id;
const apiKey = import.meta.env.BUNGIE_API_KEY;

// ===== Standardwerte =====
let playerName = "Unknown Guardian";
let bungieTag = "";
let clanName: string | null = null;
let clanTag: string | null = null;
let emblemBackground = "/missing_emblem_special.jpg";
let emblemIcon = "/missing_emblem_icon.png";
let compPoints = 0;
let compProgressToNext = 0;
let compNextLevelAt = 0;
let isLoading = true;

// ===== Socials (Platzhalter) =====
const socials = {
  twitch: "test",
  youtube: "test",
  reddit: "test",
  website: "https://beta.notrgx.com/",
};

try {
  // 1️⃣ Profil abrufen
  const res = await fetch(
    `https://www.bungie.net/Platform/Destiny2/${membershipType}/Profile/${membershipId}/?components=100,200,202,900`,
    { headers: { "X-API-Key": apiKey } },
  );
  const data = await res.json();
  if (!data?.Response) throw new Error("Invalid Bungie API response");

  // 2️⃣ Name + Clan
  const user = data.Response.profile?.data?.userInfo;
  if (user) {
    playerName =
      user.bungieGlobalDisplayName ?? user.displayName ?? "Unknown Guardian";
    bungieTag = user.bungieGlobalDisplayNameCode
      ? `#${user.bungieGlobalDisplayNameCode}`
      : "";
  }

  // 3️⃣ Charakterdaten
  const characters = data.Response.characters?.data ?? {};
  const firstChar = Object.values(characters)[0] as
    | {
        emblemPath?: string;
        emblemBackgroundPath?: string;
        emblemHash?: number;
      }
    | undefined;

  if (firstChar) {
    if (firstChar.emblemPath)
      emblemIcon = `https://www.bungie.net${firstChar.emblemPath}`;
    if (firstChar.emblemBackgroundPath)
      emblemBackground = `https://www.bungie.net${firstChar.emblemBackgroundPath}`;

    // 4️⃣ Manifest-Call → Secondary Special
    if (firstChar.emblemHash) {
      const manRes = await fetch(
        `https://www.bungie.net/Platform/Destiny2/Manifest/DestinyInventoryItemDefinition/${firstChar.emblemHash}/`,
        { headers: { "X-API-Key": apiKey } },
      );
      const man = await manRes.json();
      const def = man?.Response ?? {};
      const special =
        def.secondarySpecial ??
        def.secondaryOverlay ??
        def.secondaryIcon ??
        null;
      if (special) emblemBackground = `https://www.bungie.net${special}`;
    }
  }

  const progressions = (data.Response.characterProgressions?.data ??
    {}) as Record<string, { progressions?: Record<string, any> }>;
  const firstProg = Object.values(progressions)[0]?.progressions ?? {};
  const compProg = firstProg["3696598664"];
  if (compProg) {
    compPoints = compProg.currentProgress ?? 0;
    compProgressToNext = compProg.progressToNextLevel ?? 0;
    compNextLevelAt = compProg.nextLevelAt ?? 0;
  }
  isLoading = false;
} catch (err) {
  console.error("Bungie API Error:", err);
}

try {
  const clanRes = await fetch(
    `https://www.bungie.net/Platform/GroupV2/User/${membershipType}/${membershipId}/0/1`,
    { headers: { "X-API-Key": apiKey } },
  );
  const clanData = await clanRes.json();

  const group = clanData?.Response?.results?.[0]?.group;
  if (group) {
    clanName = group.name ?? null;
    clanTag = group.clanInfo?.clanCallsign ?? null;
  }
} catch {
  clanName = null;
  clanTag = null;
}

const badgeKey = bungieTag ? `${playerName}${bungieTag}` : playerName;

const userBadges = membershipId
  ? getUserBadges(membershipId)
      .slice()
      .sort((a, b) => BADGES[a].priority - BADGES[b].priority)
  : [];
---

<Layout title={`${playerName} — CruciCore`}>
  <!-- Emblem Header -->
  <section
    class="cc-header"
    style={!isLoading ? `background-image:url('${emblemBackground}')` : ""}
  >
    <div class="cc-header__scrim"></div>

    <div class="cc-header__inner">
      {
        isLoading ? (
          <>
            <div class="cc-header__icon skeleton skeleton-avatar" />

            <div class="cc-header__info">
              <div class="skeleton skeleton-line title" />
              <div class="skeleton skeleton-line small" />
            </div>
          </>
        ) : (
          <>
            <img src={emblemIcon} alt="Emblem" class="cc-header__icon" />

            <div class="cc-header__info">
              <h2 class="cc-header__name">
                {playerName}
                <span class="cc-header__tag">{bungieTag}</span>

                {userBadges.length > 0 && (
                  <section class="profile-badges">
                    {userBadges.map((b) => (
                      <BadgePill badge={b} />
                    ))}
                  </section>
                )}
              </h2>

              <div class="cc-header__meta">
                {clanName && (
                  <span class="pill">
                    {clanTag && <strong>[{clanTag}]</strong>} {clanName}
                  </span>
                )}
                <span>•</span>
                <span class="pill">Platform: Steam</span>
              </div>
            </div>
          </>
        )
      }
    </div>
  </section>

  <!-- Hauptinhalt -->
  <main class="container">
    <section style="margin-top:32px;">
      <h2>Trials of Osiris</h2>

      <div class="grid">
        {
          isLoading ? (
            Array.from({ length: 4 }).map(() => (
              <div class="col-3">
                <div class="skeleton skeleton-card" />
              </div>
            ))
          ) : (
            <>
              <div class="col-3">
                <StatBlock label="Weekly KD" value="—" />
              </div>
              <div class="col-3">
                <StatBlock label="Seasonal KD" value="—" />
              </div>
              <div class="col-3">
                <StatBlock label="Flawless Count" value="—" />
              </div>
              <div class="col-3">
                <StatBlock label="Flawless this week" value="—" />
              </div>
            </>
          )
        }
      </div>
    </section>

    <section style="margin-top:18px;">
      <h2>Competitive / Crucible</h2>

      <div class="grid">
        {
          isLoading ? (
            Array.from({ length: 3 }).map(() => (
              <div class="col-4">
                <div class="skeleton skeleton-card" />
              </div>
            ))
          ) : (
            <>
              <div class="col-4">
                <StatBlock label="Overall KD" value="—" />
              </div>
              <div class="col-4">
                <StatBlock label="Kills" value="—" />
              </div>
              <div class="col-4">
                <StatBlock label="Deaths" value="—" />
              </div>
            </>
          )
        }
      </div>

      {
        !isLoading && (
          <div style="margin-top:20px;">
            <CompRankBars
              points={compPoints}
              nextLevelAt={compNextLevelAt}
              toNext={compProgressToNext}
            />
          </div>
        )
      }
    </section>
  </main>
</Layout>
