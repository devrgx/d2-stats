---
import Layout from "../../layouts/Layout.astro";
import { getUserById, updateUserSettings, parseJSONSafe } from "../../db.js";

export const prerender = false;

const cookies = Astro.request.headers.get("cookie") ?? "";
const match = cookies.match(/bungie=([^;]+)/);
const currentUser = match ? JSON.parse(decodeURIComponent(match[1])) : null;

if (!currentUser) {
  return Astro.redirect("/api/auth/login");
}

const dbUser = await getUserById(currentUser.membershipId);
const settings = parseJSONSafe(dbUser?.settings, { showTwitch: false });

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  const showTwitch = form.get("showTwitch") === "on";
  const next = { ...settings, showTwitch };
  await updateUserSettings(currentUser.membershipId, next);
  return Astro.redirect("/profile/settings?ok=1");
}

const ok = Astro.url.searchParams.get("ok") === "1";
---

<Layout title="Profile Settings â€” CruciCore">
  <section class="card">
    <h1 style="margin-top:0;">Profile Settings</h1>
    {ok && <div class="notice success">Saved successfully.</div>}

    <form method="POST" class="settings-form">
      <div class="row">
        <label class="toggle">
          <input type="checkbox" name="showTwitch" checked={settings.showTwitch ? true : undefined} />
          <span class="slider" aria-hidden="true"></span>
          <span class="label">Show Twitch link on my profile</span>
        </label>
      </div>

      <button class="btn primary" type="submit">Save</button>
    </form>

    <div class="help muted" style="margin-top:14px;">
      More options will be added here later (YouTube, Website, privacy, etc.).
    </div>
  </section>
</Layout>

<style>
.settings-form .row {
  margin: 14px 0;
}

.toggle {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}
.toggle input {
  display: none;
}
.toggle .slider {
  position: relative;
  width: 48px;
  height: 26px;
  border-radius: 999px;
  background: #2a3444;
  border: 1px solid var(--border);
  transition: background .2s ease;
}
.toggle .slider::after {
  content: "";
  position: absolute;
  top: 3px; left: 3px;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: #fff;
  transition: transform .2s ease;
}
.toggle input:checked + .slider {
  background: linear-gradient(90deg, var(--accent), var(--accent-alt));
}
.toggle input:checked + .slider::after {
  transform: translateX(22px);
}
.toggle .label {
  font-weight: 600;
}
.notice.success {
  background: rgba(0, 209, 255, .12);
  border: 1px solid rgba(0, 209, 255, .3);
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 10px;
}
</style>
